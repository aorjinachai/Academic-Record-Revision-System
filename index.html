<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for Thai characters -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å */
    body, input, button, select, textarea, legend {
      font-family: 'Sarabun', sans-serif;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô scrollbar */
    ::-webkit-scrollbar {
      display: none;
    }
    /* Custom animation for spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 bg-[#FDFDDE]">

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
      <div class="spinner h-16 w-16 border-4 border-t-4 border-t-blue-500 border-gray-200 rounded-full"></div>
    </div>

    <!-- Login View -->
    <div id="loginView" class="w-full max-w-md">
      <div class="bg-white rounded-xl shadow-2xl p-8">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-800"><span class="opacity-25">üìö</span> ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
          <p class="text-xl text-gray-700 mt-1">0, ‡∏£ ‡πÅ‡∏•‡∏∞ ‡∏°‡∏ú</p>
          <p class="text-gray-600 mt-2 font-semibold">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏°‡πà‡∏à‡∏±‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</p>
        </div>
        <form id="loginForm">
          <div class="mb-4">
            <label for="id_card" class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
            <input type="text" id="id_card" name="id_card" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 1234567890123" required>
          </div>
          <div class="mb-6">
            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏õ‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
            <input type="password" id="password" name="password" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 25000101" required>
          </div>
          <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
            <span>üîë</span>
            <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          </button>
        </form>
        <p id="loginError" class="text-red-500 text-center mt-4 font-semibold hidden"></p>
      </div>
    </div>

    <!-- Form View -->
    <div id="formView" class="hidden w-full max-w-4xl">
      <div class="bg-white rounded-xl shadow-2xl p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center space-x-2">
              <span>üö™</span>
              <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
        </div>
        
        <form id="submissionForm" class="space-y-6">
          <!-- Teacher Info -->
          <fieldset class="border p-4 rounded-lg">
            <legend class="px-2 font-semibold text-lg text-gray-700">1Ô∏è‚É£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</legend>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
              <input type="text" name="teacherFirstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="p-2 border rounded-md" required>
              <input type="text" name="teacherLastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="p-2 border rounded-md" required>
              <select name="teacherDept" class="p-2 border rounded-md" required>
                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø</option>
                <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
                <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                <option value="‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
                <option value="‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
                <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
          </fieldset>

          <!-- Course Info -->
          <fieldset class="border p-4 rounded-lg">
            <legend class="px-2 font-semibold text-lg text-gray-700">2Ô∏è‚É£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
              <input type="text" name="courseId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" class="p-2 border rounded-md" required>
              <input type="text" name="courseName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤" class="p-2 border rounded-md" required>
            </div>
          </fieldset>

          <!-- Student Info -->
          <fieldset class="border p-4 rounded-lg">
            <legend class="px-2 font-semibold text-lg text-gray-700">3Ô∏è‚É£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</legend>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
              <input type="text" name="studentId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" class="p-2 border rounded-md" required>
              <input type="text" name="studentFirstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="p-2 border rounded-md" required>
              <input type="text" name="studentLastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="p-2 border rounded-md" required>
              <div class="grid grid-cols-2 gap-2">
                <input type="text" name="studentLevel" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô" class="p-2 border rounded-md" required>
                <input type="text" name="studentRoom" placeholder="‡∏´‡πâ‡∏≠‡∏á" class="p-2 border rounded-md" required>
              </div>
            </div>
          </fieldset>

          <!-- Grade Correction Info -->
          <fieldset class="border p-4 rounded-lg">
            <legend class="px-2 font-semibold text-lg text-gray-700">4Ô∏è‚É£ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô</legend>
            <div class="grid grid-cols-1 mt-2">
              <input type="text" name="newGrade" placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" class="p-2 border rounded-md" required>
            </div>
          </fieldset>

          <div class="flex justify-end space-x-4 mt-6">
            <button type="button" id="previewButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
              <span>üëÄ</span>
              <span>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</span>
            </button>
            <button type="button" id="submitButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
              <span>üöÄ</span>
              <span>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-full overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-center">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h3>
            <div id="previewContent" class="space-y-4 text-gray-800"></div>
            <div class="flex justify-center space-x-4 mt-8">
                <button id="editButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button id="confirmSubmitButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
            <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 id="successMessage" class="text-xl font-semibold mt-4 text-gray-800"></h3>
            <button id="closeSuccessModalButton" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <footer class="w-full text-center text-gray-700 text-sm p-4 mt-auto">
      ‚ú® Designed by Chanitsara Jinachai | Developed with Google AI | ¬© 2025 ‚ú®
    </footer>

  </div>

  <script>
    // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡∏ô‡∏≥ Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÉ‡∏´‡∏°‡πà ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-ZAmjJHaYgaXCCR12cDc5xfUIhHS3xfoYVid6nvFNkaWPoySvoKHH5Iit_eXN-5E/exec";

    // --- DOM Elements ---
    const loginView = document.getElementById('loginView');
    const formView = document.getElementById('formView');
    const loginForm = document.getElementById('loginForm');
    const submissionForm = document.getElementById('submissionForm');
    const loginError = document.getElementById('loginError');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const logoutButton = document.getElementById('logoutButton');
    const previewButton = document.getElementById('previewButton');
    const submitButton = document.getElementById('submitButton');
    const previewModal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const editButton = document.getElementById('editButton');
    const confirmSubmitButton = document.getElementById('confirmSubmitButton');
    const successModal = document.getElementById('successModal');
    const successMessage = document.getElementById('successMessage');
    const closeSuccessModalButton = document.getElementById('closeSuccessModalButton');

    // --- Helper Functions ---
    function showLoading(isLoading) {
      if (loadingSpinner) loadingSpinner.classList.toggle('hidden', !isLoading);
    }

    function showLoginError(message) {
      if (loginError) {
        loginError.textContent = message;
        loginError.classList.remove('hidden');
      }
    }

    function switchView(viewName) {
      if(loginView) loginView.classList.add('hidden');
      if(formView) formView.classList.add('hidden');
      if(loginError) loginError.classList.add('hidden');

      if (viewName === 'login') {
        if(loginView) loginView.classList.remove('hidden');
      } else if (viewName === 'form') {
        if(formView) formView.classList.remove('hidden');
      }
    }

    function isFormValid() {
        return submissionForm.checkValidity();
    }

    function populatePreview() {
        const form = submissionForm.elements;
        const teacherFullName = `${form.teacherFirstName.value || ''} ${form.teacherLastName.value || ''}`.trim();
        const studentFullName = `${form.studentFirstName.value || ''} ${form.studentLastName.value || ''}`.trim();
        const studentFullClass = `${form.studentLevel.value || ''}/${form.studentRoom.value || ''}`.trim();

        previewContent.innerHTML = `
            <p><strong>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</strong> ${teacherFullName || '-'}</p>
            <p><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø:</strong> ${form.teacherDept.value || '-'}</p>
            <hr class="my-2">
            <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${form.courseId.value || '-'}</p>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${form.courseName.value || '-'}</p>
            <hr class="my-2">
            <p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${form.studentId.value || '-'}</p>
            <p><strong>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentFullName || '-'}</p>
            <p><strong>‡∏ä‡∏±‡πâ‡∏ô:</strong> ${studentFullClass || '-'}</p>
            <hr class="my-2">
            <p><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> <span class="font-bold text-green-600">${form.newGrade.value || '-'}</span></p>
        `;
    }
    
    function handleFormSubmission() {
        showLoading(true);
        const form = submissionForm.elements;
        const dataObject = {
          teacherFirstName: form.teacherFirstName.value,
          teacherLastName: form.teacherLastName.value,
          teacherDept: form.teacherDept.value,
          courseId: form.courseId.value,
          courseName: form.courseName.value,
          studentId: form.studentId.value,
          studentFirstName: form.studentFirstName.value,
          studentLastName: form.studentLastName.value,
          studentLevel: form.studentLevel.value,
          studentRoom: form.studentRoom.value,
          newGrade: form.newGrade.value,
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'submit', formData: dataObject })
        })
        .then(res => res.json())
        .then(result => {
            showLoading(false);
            if (result.success) {
                successMessage.textContent = result.message;
                successModal.classList.remove('hidden');
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + result.message);
            }
        })
        .catch(error => {
            showLoading(false);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error);
        });
    }

    // --- Google Script Handlers ---
    function onLoginSuccess(response) {
      showLoading(false);
      if (response.success) {
        // Split name and pre-fill if possible
        const teacherNameInput = document.querySelector('input[name="teacherFirstName"]');
        const teacherLastNameInput = document.querySelector('input[name="teacherLastName"]');
        const nameParts = response.name.split(' ');
        teacherNameInput.value = nameParts[0] || '';
        teacherLastNameInput.value = nameParts.slice(1).join(' ') || '';
        
        teacherNameInput.readOnly = true;
        teacherLastNameInput.readOnly = true;
        teacherNameInput.classList.add('bg-gray-200', 'cursor-not-allowed');
        teacherLastNameInput.classList.add('bg-gray-200', 'cursor-not-allowed');
        switchView('form');
      } else {
        showLoginError("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    }

    function onLoginFailure(error) {
      showLoading(false);
      showLoginError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
    }

    // --- Event Listeners ---
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = loginForm.id_card.value.trim();
      const password = loginForm.password.value;
      if (!id || !password) {
        showLoginError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
      }
      showLoading(true);

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'login', id: id, password: password })
      })
      .then(res => res.json())
      .then(data => {
        onLoginSuccess(data);
      })
      .catch(error => {
        onLoginFailure(error);
      });
    });

    logoutButton.addEventListener('click', () => {
        const teacherNameInput = document.querySelector('input[name="teacherFirstName"]');
        const teacherLastNameInput = document.querySelector('input[name="teacherLastName"]');
        loginForm.reset();
        submissionForm.reset();
        teacherNameInput.value = '';
        teacherLastNameInput.value = '';
        teacherNameInput.readOnly = false;
        teacherLastNameInput.readOnly = false;
        teacherNameInput.classList.remove('bg-gray-200', 'cursor-not-allowed');
        teacherLastNameInput.classList.remove('bg-gray-200', 'cursor-not-allowed');
        switchView('login');
    });

    previewButton.addEventListener('click', () => {
      if (isFormValid()) {
        populatePreview();
        previewModal.classList.remove('hidden');
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
      }
    });
    
    submitButton.addEventListener('click', () => {
        if (isFormValid()) {
            if(confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                handleFormSubmission();
            }
        } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
        }
    });

    editButton.addEventListener('click', () => {
      previewModal.classList.add('hidden');
    });

    confirmSubmitButton.addEventListener('click', () => {
      previewModal.classList.add('hidden');
      handleFormSubmission();
    });
    
    closeSuccessModalButton.addEventListener('click', () => {
        successModal.classList.add('hidden');
        // Reset form after user acknowledges success
        const teacherFirstName = document.querySelector('input[name="teacherFirstName"]').value;
        const teacherLastName = document.querySelector('input[name="teacherLastName"]').value;
        const teacherDept = document.querySelector('select[name="teacherDept"]').value;
        submissionForm.reset();
        document.querySelector('input[name="teacherFirstName"]').value = teacherFirstName;
        document.querySelector('input[name="teacherLastName"]').value = teacherLastName;
        document.querySelector('select[name="teacherDept"]').value = teacherDept;
    });
  </script>
</body>
</html>
